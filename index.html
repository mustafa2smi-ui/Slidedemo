<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Darul Islam Q&A | Authentic Islamic Questions, Answers & Fiqh</title>
<meta name="description" content="Find authentic Islamic Questions and Answers (Q&A), Fiqh Rulings, Duas, and Hajj guides based on trusted references. Darul Islam‚Äôs reliable knowledge hub.">
<meta name="keywords" content="islamic q&a, fiqh, islamic questions and answers, dua, rabbana, hajj guide, authentic islamic rulings, sunnah, hadith">
<meta property="og:title" content="Darul Islam Q&A" />
<meta property="og:description" content="Authentic Islamic Questions and Answers." />
<meta property="og:image" content="icon-512.png" />
<meta property="og:url" content="https://YOUR-NETLIFY-URL.netlify.app" />
<link rel="manifest" href="manifest.json" />
<style>
  body {font-family: sans-serif; background:#f9f9f9; margin:0; padding:0;}
  header {background:#004d40; color:white; padding:15px; text-align:center;}
  .card {
    background:white; margin:15px; padding:15px; border-radius:12px; 
    box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer;
    position: relative; /* Watermark ke liye zaroori */
    overflow: hidden; /* Watermark ko card ke bahar jaane se rokta hai */
  }
  .post-card { /* Home page cards */
    background:white; margin:15px; padding:15px; border-radius:12px; 
    box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer;
  }
  
  .card img {
      max-width:100%; 
      height: auto; 
      display: block; 
      border-radius:10px; 
      margin-top:8px;
  }
  
  /* Buttons styling */
  .share-btn, .img-share-btn, .color-btn, .back-btn {border:none; padding:8px 15px; border-radius:8px; cursor:pointer; margin-top:10px;}
  .share-btn {background:#00897b; color:white;}
  .img-share-btn {background:#4caf50; color:white;}
  .color-btn {background:#ff9800; color:white;}
  .back-btn {background:#607d8b; color:white;}
  
  /* New Menu Styling */
  .menu {
      background:#e0f2f1;
      display: flex;
      flex-wrap: wrap; 
      justify-content: center; 
      padding: 5px; 
      gap: 8px; 
  }
  .menu a {
      color: #004d40;
      text-decoration: none;
      font-weight: bold;
      padding: 8px 15px;
      border: 2px solid #004d40;
      border-radius: 20px;
      transition: background 0.3s;
      white-space: nowrap;
  }
  .menu a:hover {
      background: #004d40;
      color: white;
  }
  
  .hidden {display:none;}
  
  /* YouTube Embed Styling */
  .youtube-embed { 
      margin-top: 15px; 
      margin-bottom: 15px; 
      position: relative; 
      width: 100%; 
      height: 0; 
      padding-bottom: 56.25%; 
      overflow: hidden;
  }
  .youtube-embed iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 10px; 
  }

  /* üÜï Watermark Style */
  .watermark {
      position: absolute;
      bottom: 5px; /* Thoda padding se upar */
      right: 15px; /* Right se padding */
      font-size: 0.7em;
      color: rgba(0, 0, 0, 0.3); /* Light grey, transparent */
      font-weight: bold;
      pointer-events: none; /* Mouse events ignore karein */
      z-index: 10; /* Card elements ke upar rakhein */
  }

  a { color: #0077cc; text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* Style for content separation without labels */
  .content-section { margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
  .content-section:last-of-type { border-bottom: none; }
  h3 { margin-top: 0; margin-bottom: 10px; }
/* --------------------------------- */
/* üÜï DARK MODE AND THEME VARIABLES */
/* --------------------------------- */
:root {
  --bg: #f9f9f9; /* Light background */
  --text: #111; /* Dark text */
  --card: #ffffff; /* Card background in light mode */
  --accent: #004d40; /* Your primary green (Header/Footer/Buttons) */
  --accent-light: #00897b; /* Share Button */
  --secondary-bg: #e0f2f1; /* Menu background */
}

body.dark {
  --bg: #121212;
  --text: #eee;
  --card: #1e1e1e;
  --accent: #2ecc71; /* Dark mode green accent */
  --accent-light: #258f50;
  --secondary-bg: #333333;
}

body {
  /* Existing styles */
  background: var(--bg);
  color: var(--text);
  transition: all 0.4s ease; /* Smooth transition for dark mode */
}

/* --------------------------------- */
/* üÜï HEADER AND FOOTER STYLING (Green) */
/* --------------------------------- */
header {
  background: var(--accent); /* Dark Green */
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
}

header h2 { /* Aapke existing h2 ko h1 se change karein ya use karein */
  margin: 0;
}

#themeToggle {
  font-size: 20px;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
}

footer {
  text-align: center;
  padding: 10px;
  background: var(--accent); /* Dark Green */
  color: #fff;
}

/* Update Button styles to use new variables */
.share-btn {background: var(--accent-light); color:white;}
.back-btn {background:#607d8b; color:white;}
.color-btn {background:#ff9800; color:white;}


/* --------------------------------- */
/* üÜï NAMAZ/LOCATION/DISCLAIMER BOX STYLES */
/* --------------------------------- */
.info-box {
  margin: 10px auto;
  padding: 10px 14px;
  max-width: 90%;
  border: 2px solid var(--card); /* Adjust border color */
  border-radius: 10px;
  background: var(--card);
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  font-size: 15px;
  color: var(--text);
  text-align: center;
  transition: 0.3s;
}
.info-box:hover {
  background: var(--secondary-bg);
  transform: scale(1.02);
}

.disclaimer {
  background: #fff8e1;
  border-color: #fbbf24;
  color: #854d0e;
}
body.dark .disclaimer {
   background: #3c2e00; 
   border-color: #fbbf24;
   color: #e0d0a0;
}

.namaz-times {
  margin: 10px auto;
  padding: 15px;
  text-align: center;
  background: linear-gradient(90deg, var(--accent), #00796b); /* Green gradient */
  color: #fff;
  font-weight: 600;
  border-radius: 8px;
  max-width: 90%;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}
.namaz-times h3 {
  margin-top: 0;
  margin-bottom: 10px;
  color: #e0f2f1; /* Light color for heading */
}
.namaz-times ul li {
    text-align: left;
    padding: 5px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}
.namaz-times ul li:last-child {
    border-bottom: none;
}
  
</style>
</head>
<body>
<header>
  <h1>üïå Darul Islam Q&A</h1>
  <button id="themeToggle">üåô</button>
</header>
<div class="menu">
  <a href="#" onclick="loadSheet('qa')">Q&A</a>
  <a href="#" onclick="loadSheet('dua')">Dua</a>
  <a href="#" onclick="loadSheet('rabbana')">Rabbana</a>
  <a href="#" onclick="loadSheet('hajj')">Hajj</a>
  <a href="#" onclick="loadSheet('fiqh')">Fiqh</a>
  <a href="#" onclick="loadSheet('aqidah')">Aqidah</a>
</div>
<div id="locationBox" class="info-box" style="cursor: pointer;" onclick="useMyLocation()">
  üìç <span id="locationText">Detecting your location...</span>
</div>

<div id="namazTimes" class="namaz-times">
  üïã Loading Namaz Times...
</div>

<div id="disclaimerBox" class="info-box disclaimer">
  ‚ö†Ô∏è <b>Disclaimer:</b> Salah timings may vary slightly depending on your local Masjid or calculation method.
</div>

  <!--
<header>
  <h2>Darul Islam Q&A</h2>
</header>

<div class="menu">
  <a href="#" onclick="loadSheet('qa')">Q&A</a>
  <a href="#" onclick="loadSheet('dua')">Dua</a>
  <a href="#" onclick="loadSheet('rabbana')">Rabbana</a>
  <a href="#" onclick="loadSheet('hajj')">Hajj</a>
  <a href="#" onclick="loadSheet('fiqh')">Fiqh</a>
  <a href="#" onclick="loadSheet('aqidah')">Aqidah</a>
</div>
-->
<div id="posts"></div>

<div id="detailContainer" class="hidden"></div>

<script id="schema-data" type="application/ld+json"></script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  let allPosts = []; 
  const POSTS_PER_PAGE = 5; 
  let currentVisiblePosts = 0; 
  const defaultTitle = "Darul Islam Q&A | Authentic Islamic Questions, Answers & Fiqh";
  const defaultDescription = "Find authentic Islamic Questions and Answers (Q&A), Fiqh Rulings, Duas, and Hajj guides based on trusted references. Darul Islam‚Äôs reliable knowledge hub.";
  const WEBSITE_NAME = "DarulIslamQnA.com"; // üÜï Watermark ke liye
    
  // --- Google Sheet URLs ---
  const sheets = {
    qa: "https://docs.google.com/spreadsheets/d/1lnXSvR2j6hTGWT_Bj7H3BTnDtpnPWQJl0OdpffeWWr4/gviz/tq?tqx=out:json",
    dua: "https://docs.google.com/spreadsheets/d/1DtRlkaP23ihYmN8mn4Gx7deLicpVhDY6AiY-bN5pqt8/gviz/tq?tqx=out:json",
    rabbana: "https://docs.google.com/spreadsheets/d/YOUR_RABBANA_SHEET_ID/gviz/tq?tqx=out:json",
    hajj: "https://docs.google.com/spreadsheets/d/YOUR_HAJJ_SHEET_ID/gviz/tq?tqx=out:json",
    fiqh: "https://docs.google.com/spreadsheets/d/YOUR_FIQH_SHEET_ID/gviz/tq?tqx=out:json", 
    aqidah: "https://docs.google.com/spreadsheets/d/YOUR_AQIDAH_SHEET_ID/gviz/tq?tqx=out:json" 
  };

  const themeColors = {
    qa: "#ffe0b2",
    dua: "#e8f5e9",
    rabbana: "#e3f2fd",
    hajj: "#fff3e0",
    fiqh: "#f3e5f5",
    aqidah: "#e1f5fe"
  };

  function makeLinksClickable(text) {
    if (!text) return "";
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
  }
  
  function getYoutubeEmbed(link) {
    if (!link) return "";
    
    let videoId = "";
    
    if (link.includes("youtube.com/watch?v=")) {
      videoId = link.split("v=")[1]?.split("&")[0];
    } else if (link.includes("youtube.com/shorts/")) {
      videoId = link.split("youtube.com/shorts/")[1]?.split("?")[0];
    } else if (link.includes("youtu.be/")) {
      videoId = link.split("youtu.be/")[1]?.split("?")[0];
    } else if (link.includes("youtube.com/embed/")) {
        videoId = link.split("youtube.com/embed/")[1]?.split("?")[0];
    }
    
    if(videoId && videoId.length >= 10) { 
        return `<div class="youtube-embed"><iframe src="https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
    }
    return "";
  }
  // ===============================================
// üåô DARK/LIGHT MODE LOGIC
// ===============================================

const themeBtn = document.getElementById('themeToggle');
if (themeBtn) {
    themeBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        themeBtn.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    });

    // Check saved theme on load
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark');
        themeBtn.textContent = '‚òÄÔ∏è';
    } else {
        themeBtn.textContent = 'üåô';
    }
}
// ===============================================
// üåô END OF DARK/LIGHT MODE LOGIC
// ===============================================
  
  async function loadSheet(type='qa') {
    document.body.style.background = themeColors[type] || "#f7f7f7";
    const sheetUrl = sheets[type];
    if(!sheetUrl || sheetUrl.includes("YOUR_")) { 
      document.getElementById('posts').innerHTML = `<p style='color:orange; text-align:center'>‚ö†Ô∏è Please replace YOUR_SHEET_ID for ${type.toUpperCase()} in the code.</p>`;
      return;
    }
    
    document.getElementById('posts').innerHTML = "<p style='text-align:center'>‚è≥ Loading...</p>";

    try {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2)); 
      const rows = json.table.rows;

      const posts = rows.map((r, i) => {
        let rawDate = r.c[5]?.v || "";
        
        if (/Date\(\d+,\d+,\d+\)/.test(rawDate)) {
          const match = rawDate.match(/Date\((\d+),(\d+),(\d+)\)/);
          if (match) {
            const year = match[1];
            const month = String(parseInt(match[2]) + 1).padStart(2, '0');
            const day = String(match[3]).padStart(2, '0');
            rawDate = `${day}/${month}/${year}`;
          }
        }

        return {
          id: i + 1,
          title: r.c[0]?.v || "",
          question: r.c[1]?.v || "",
          answer: r.c[2]?.v || "",
          reference: r.c[3]?.v || "",
          link: r.c[4]?.v || "",
          date: rawDate.trim(),
          image: r.c[6]?.v || ""
        };
      }).filter(p=>p.title); 

      allPosts = posts; 
      renderPosts(posts);

      document.title = defaultTitle;
      document.querySelector('meta[name="description"]').setAttribute("content", defaultDescription);
      document.querySelector('meta[property="og:title"]').setAttribute("content", "Darul Islam Q&A");
      document.querySelector('meta[property="og:description"]').setAttribute("content", "Authentic Islamic Questions and Answers.");
      document.getElementById('schema-data').textContent = ''; 

    } catch(err) {
      document.getElementById('posts').innerHTML = "<p style='color:red; text-align:center'>‚ùå Error loading data. Please check Google Sheet URL format.</p>";
      console.error(err);
    }
  }

function renderPosts(posts){
    const container = document.getElementById("posts");
    
    currentVisiblePosts = Math.min(posts.length, POSTS_PER_PAGE);
    
    const visiblePosts = posts.slice(0, currentVisiblePosts);

    let html = visiblePosts.map(p=>{
        return `
            <div class="post-card" onclick="openPost(${p.id})">
                <h3>${p.title}</h3>
            </div>
        `;
    }).join('');
    
    if (posts.length > POSTS_PER_PAGE) {
        html += `<div style="text-align:center; padding-bottom:15px;"><button id="showMoreBtn" class="share-btn" onclick="showMorePosts()">Show More (${posts.length - currentVisiblePosts} remaining)</button></div>`;
    }

    container.innerHTML = html;
    document.getElementById("posts").classList.remove("hidden");
    document.getElementById("detailContainer").classList.add("hidden");
}

function showMorePosts() {
    const container = document.getElementById("posts");
    const posts = allPosts; 
    
    const nextBatchSize = 5; 
    const newEndIndex = Math.min(posts.length, currentVisiblePosts + nextBatchSize);

    const newPostsHtml = posts.slice(currentVisiblePosts, newEndIndex).map(p => `
        <div class="post-card" onclick="openPost(${p.id})">
            <h3>${p.title}</h3>
        </div>
    `).join('');

    const showMoreBtn = document.getElementById("showMoreBtn");
    if (showMoreBtn) {
        showMoreBtn.parentElement.insertAdjacentHTML('beforebegin', newPostsHtml);
    } else {
        container.insertAdjacentHTML('beforeend', newPostsHtml); 
    }
    
    currentVisiblePosts = newEndIndex;

    const remaining = posts.length - currentVisiblePosts;

    if (remaining > 0) {
        showMoreBtn.textContent = `Show More (${remaining} remaining)`;
    } else if (showMoreBtn) {
        showMoreBtn.parentElement.remove(); 
    }
}


  // --- Open detail card ---
  function openPost(id){
    const p = allPosts.find(x=>x.id===id); 
    if (!p) return; 
    
    // DYNAMIC SEO UPDATE (Unchanged)
    document.title = `${p.title} | Darul Islam Q&A`;
    const postDescription = p.question ? p.question.substring(0, 150) + (p.question.length > 150 ? "..." : "") : "Authentic Islamic Q&A Post.";
    document.querySelector('meta[name="description"]').setAttribute("content", postDescription);
    document.querySelector('meta[property="og:title"]').setAttribute("content", p.title);
    document.querySelector('meta[property="og:description"]').setAttribute("content", postDescription);

    const schemaElement = document.getElementById('schema-data');
    if (p.question && p.answer) {
        const schema = { "@context": "https://schema.org", "@type": "QAPage", "mainEntity": { "@type": "Question", "name": p.title, "text": p.question, "acceptedAnswer": { "@type": "Answer", "text": p.answer, "url": window.location.href } } };
        schemaElement.textContent = JSON.stringify(schema);
    } else {
        schemaElement.textContent = ''; 
    }
    
    const d = document.getElementById("detailContainer");
    const youtubeEmbed = getYoutubeEmbed(p.link);
    const isYoutubeLink = p.link && (p.link.includes("youtube.com") || p.link.includes("youtu.be"));
    const displayLink = (!youtubeEmbed && !isYoutubeLink && p.link) ? 
        `<div class="content-section"><a href="${p.link}" target="_blank">üîó View Source</a></div>` : "";


    d.innerHTML = `
      <div class="card" id="detailCard">
        
        <h3>${p.title}</h3> 
        
        ${p.question ? `<div class="content-section">${p.question}</div>` : ""} 
        
        ${p.answer ? `<div class="content-section">${makeLinksClickable(p.answer)}</div>` : ""}
        
        ${p.reference ? `<div class="content-section"><i>${makeLinksClickable(p.reference)}</i></div>` : ""}
        
        ${youtubeEmbed} 
        
        ${displayLink}
        
        ${p.image ? `<img src="${p.image}" style="max-width:100%; height:auto; border-radius:10px; margin-top:10px; display:block;">` : ""}
        
        <p style="font-size:0.8em; color:#777; margin-top:10px;">${p.date || "‚Äî"}</p>
        
        <span class="watermark">${WEBSITE_NAME}</span>

        <div>
          <button class="back-btn" onclick="goBack()">‚¨Ö Back</button>
          <button class="color-btn" onclick="changeColor()">üé® Change BG</button>
          <button class="share-btn" onclick='prepareShare(${p.id})'>üì§ Share</button>
        </div>
      </div>
    `;
    document.getElementById("posts").classList.add("hidden");
    d.classList.remove("hidden");
  }

  function goBack(){
    document.getElementById("detailContainer").classList.add("hidden");
    document.getElementById("posts").classList.remove("hidden");
    
    document.title = defaultTitle;
    document.querySelector('meta[name="description"]').setAttribute("content", defaultDescription);
    document.querySelector('meta[property="og:title"]').setAttribute("content", "Darul Islam Q&A");
    document.querySelector('meta[property="og:description"]').setAttribute("content", "Authentic Islamic Questions and Answers.");
    document.getElementById('schema-data').textContent = ''; 
  }

  function changeColor(){
    const card = document.getElementById("detailCard");
    const gradients = [
      "linear-gradient(135deg,#ffecd2,#fcb69f)",
      "linear-gradient(135deg,#a1c4fd,#c2e9fb)",
      "linear-gradient(135deg,#fddb92,#d1fdff)",
      "linear-gradient(135deg,#84fab0,#8fd3f4)",
      "linear-gradient(135deg,#fccb90,#d57eeb)",
      "linear-gradient(135deg,#e0c3fc,#8ec5fc)"
    ];
    card.style.background = gradients[Math.floor(Math.random()*gradients.length)];
  }

  // New logic: Share preference choice
  function prepareShare(id) {
    if (navigator.share) {
        if (confirm("Do you want to share the content as an Image/Screenshot?\n\n(Press 'Cancel' to share as Text/Link with custom message)")) {
             shareAsImage(id);
        } else {
            // Option 2: Custom message aur Link share karein (reliable custom text)
            shareTextOnly(id);
        }
    } else {
        // Fallback for non-supporting devices
        shareTextOnly(id);
        // Image download ke liye call karein (optional, can be commented out)
        shareAsImage(id); 
    }
  }


  // Image ke saath share karna (Custom message ki guarantee nahi)
  async function shareAsImage(id) {
    const p = allPosts.find(x => x.id === id); 
    if (!p) return;

    const card = document.getElementById("detailCard");
    
    // 1. YouTube Frame ko Chhipana
    const youtubeFrame = card.querySelector('.youtube-embed');
    if (youtubeFrame) {
        youtubeFrame.style.display = 'none';
    }
    
    const shareUrl = window.location.href;

    // FIX: Image files ke saath text ko chota rakhenge
    const shareData = {
        title: p.title || "DarulIslam Q&A",
        text: `Check out this Islamic Q&A: ${p.title}`,
        url: shareUrl, 
    };
    
    // Hide buttons before capture
    const buttons = card.querySelectorAll("button");
    buttons.forEach(b => b.style.display = "none"); 
    
    // html2canvas takes screenshot
    const canvas = await html2canvas(card, {
        allowTaint: true, 
        useCORS: true, 
        logging: false 
    });
    
    // 2. YouTube Frame ko Wapas Dikhana
    if (youtubeFrame) {
        youtubeFrame.style.display = ''; 
    }
    
    // Show buttons after capture
    buttons.forEach(b => b.style.display = ""); 
    
    canvas.toBlob(blob => {
      const file = new File([blob], "question.png", { type: "image/png" });
      
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
          ...shareData, 
          files: [file]
        }).catch(e=>console.error("Card Share canceled or failed:", e));
      } else {
        // Fallback: Download image
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'question.png';
        a.click();
      }
    }, 'image/png'); 
  }

  // üì¢ FIX: Sirf Custom Message Share karna (Reliable text/link share)
  function shareTextOnly(id) {
    const p = allPosts.find(x => x.id === id);
    if (!p) return;
    
    const customMessage = "Aur Aise hi Islamic Masail Ko janne Ke liye Website Par visit kare";
    const postContent = p.question || p.title;
    const shareUrl = window.location.href;

    const shareData = {
        title: p.title || "DarulIslam Q&A",
        // FIX: Text ko chota rakha gaya hai jismein sirf custom message hai, 
        // taki apps link preview (meta description/logo) dikha sakein.
        text: `*${p.title}*\n\n${customMessage}`, 
        url: shareUrl // URL alag se bhejenge, jo preview generate karega
    };

    if (navigator.share) {
        navigator.share(shareData).catch(error => {
            console.error("Sharing text failed:", error);
            alert("Sharing failed. Please try the Image share option.");
        });
    } else {
        // Desktop fallback
        prompt("Copy this text:", `${shareData.title}\n\n${postContent}\n\n${shareData.text}\n\n${shareData.url}`);
    }
  }
// ===============================================
// üïå NAMAZ TIME AND LOCATION FUNCTIONS
// ===============================================

// üß≠ Convert 24-hour ‚Üí 12-hour format
function convertTo12Hour(time24) {
  let [hours, minutes] = time24.split(":");
  hours = parseInt(hours);
  const ampm = hours >= 12 ? "PM" : "AM";
  hours = hours % 12 || 12;
  return `${hours}:${minutes} ${ampm}`;
}

// üó∫ Show human readable location (OpenStreetMap)
async function showAddress(lat, lng) {
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
    const data = await res.json();
    document.getElementById("locationText").innerText = `üìç ${data.display_name}`;
  } catch {
    document.getElementById("locationText").innerText = `üìç Latitude: ${lat.toFixed(2)}, Longitude: ${lng.toFixed(2)}`;
  }
}

// üåô Fetch Namaz times from API
async function fetchPrayerTimes(lat, lng, cityName = "Delhi") {
  try {
    // Save current location to local storage
    localStorage.setItem('prayerLat', lat);
    localStorage.setItem('prayerLng', lng);
    localStorage.setItem('prayerCity', cityName);

    const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lng}&method=2`);
    const data = await res.json();
    const t = data.data.timings;

    const prayerNames = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];
    let listHTML = `
      <h3>üïå Salah Times - ${cityName}</h3>
      <ul style="list-style:none;padding:0;margin:5px 0;">
    `;

    prayerNames.forEach(name => {
      const time12 = convertTo12Hour(t[name]);
      // Highlight the next prayer here if needed
      listHTML += `<li><b>${name}:</b> ${time12}</li>`;
    });

    listHTML += `
      </ul>
      <button onclick="useMyLocation()" 
        style="background:#198754;color:#fff;border:none;padding:6px 12px;
        border-radius:6px;cursor:pointer;margin-top:10px;">üìç Use My Current Location</button>
    `;

    document.getElementById("namazTimes").innerHTML = listHTML;

    // Show human readable address
    showAddress(lat, lng);
  } catch (e) {
    console.error(e);
    document.getElementById("namazTimes").textContent = "Error fetching Salah times.";
  }
}

// üìç Detect user location or fallback to saved/Delhi location
function useMyLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        fetchPrayerTimes(lat, lng, "Your Current Location");
      },
      () => {
        alert("Location permission denied! Using saved location or Delhi as default.");
        loadInitialPrayerTimes(); // Revert to saved/default
      }
    );
  } else {
    alert("Geolocation not supported on this device.");
    loadInitialPrayerTimes(); // Revert to saved/default
  }
}

// üîπ Initial Load Function: Saved Location Priority
function loadInitialPrayerTimes() {
    const savedLat = localStorage.getItem('prayerLat');
    const savedLng = localStorage.getItem('prayerLng');
    const savedCity = localStorage.getItem('prayerCity');

    if (savedLat && savedLng) {
        // Use saved location
        fetchPrayerTimes(savedLat, savedLng, savedCity || "Saved Location");
    } else {
        // Default to Delhi
        fetchPrayerTimes(28.6139, 77.2090, "Delhi (Default)");
    }
}

// üîπ Run on page load
window.addEventListener("load", loadInitialPrayerTimes);
// ===============================================
// üïå END OF NAMAZ TIME AND LOCATION FUNCTIONS
// ===============================================
  
  // --- Load default sheet ---
  loadSheet('qa');

  // --- PWA Service Worker (Kept as is) ---
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./service-worker.js")
      .then(()=>console.log("‚úÖ PWA active"))
      .catch(err=>console.error("SW failed:",err));
  }
</script>
  <footer>
  <p>¬© 2025 Darul Islam Q&A | Authentic Islamic Knowledge</p>
  </footer>
  
</body>
</html>
